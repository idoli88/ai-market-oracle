version: '3.8'

services:
  # Nginx Reverse Proxy with SSL
  nginx:
    image: nginx:alpine
    container_name: oracle_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
    depends_on:
      - api-server
    restart: "always"
    networks:
      - oracle_network

  # PostgreSQL Database (Production)
  postgres:
    image: postgres:15-alpine
    container_name: oracle_postgres
    environment:
      POSTGRES_DB: oracle
      POSTGRES_USER: oracle
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me_in_production}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: "always"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U oracle" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - oracle_network

  telegram-bot:
    build: .
    container_name: oracle_bot
    command: [ "python", "bot.py" ]
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://oracle:${DB_PASSWORD:-change_me_in_production}@postgres:5432/oracle
    volumes:
      - ./reports:/app/reports
    depends_on:
      postgres:
        condition: service_healthy
    restart: "always"
    networks:
      - oracle_network

  oracle-worker:
    build: .
    container_name: oracle_worker
    command: [ "python", "worker.py" ]
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://oracle:${DB_PASSWORD:-change_me_in_production}@postgres:5432/oracle
    volumes:
      - ./reports:/app/reports
    depends_on:
      postgres:
        condition: service_healthy
    restart: "always"
    networks:
      - oracle_network

  api-server:
    build: .
    container_name: oracle_api
    command: [ "python3", "-m", "uvicorn", "api_server:app", "--host", "0.0.0.0", "--port", "8000" ]
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://oracle:${DB_PASSWORD:-change_me_in_production}@postgres:5432/oracle
    volumes:
      - ./landing-page:/app/landing-page
      - ./admin-dashboard:/app/admin-dashboard
    depends_on:
      postgres:
        condition: service_healthy
      telegram-bot:
        condition: service_started
      oracle-worker:
        condition: service_started
    restart: "always"
    networks:
      - oracle_network

volumes:
  postgres_data:
    driver: local

networks:
  oracle_network:
    driver: bridge
